name: "[ë¦´ë¦¬ì¦ˆ] ìƒì„± (JAR íŒŒì¼ ê°±ì‹ )"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g. v1.0.0)"
        required: true
      title:
        description: "Release title"
        required: false  
  push:
    tags:
      - 'v*'          # v1.0.0, v1.0.1 ê°™ì€ íƒœê·¸ì— ë°˜ì‘

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    runs-on:
      group: organization/mygit-runner-linux

    steps:
      # 1. ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # íƒœê·¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ fetch

      # 2. ë²„ì „ ì¶”ì¶œ (íƒœê·¸ push ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ëª¨ë‘ ì§€ì›)
      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            # refs/tags/v1.0.0 -> v1.0.0
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
        shell: bash

      # 3. JAR íŒŒì¼ ì¡´ì¬ í™•ì¸
      - name: Verify JAR files
        run: |
          if [ ! -f "./artifacts/${{ steps.version.outputs.version }}/coderay-open-api.jar" ]; then
            echo "Error: JAR file not found at ./artifacts/${{ steps.version.outputs.version }}/coderay-open-api.jar"
            exit 1
          fi
          if [ ! -f "./artifacts/latest/coderay-open-api.jar" ]; then
            echo "Error: JAR file not found at ./artifacts/latest/coderay-open-api.jar"
            exit 1
          fi
          echo "JAR files verified successfully"
        shell: bash

      # 4. ë²„ì „ë³„ ë¦´ë¦¬ì¦ˆ ìƒì„±
      - name: Create Version Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ inputs.title || steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: ./artifacts/${{ steps.version.outputs.version }}/coderay-open-api.jar
          body: |
            ## ğŸ“¦ Release ${{ steps.version.outputs.version }}
            
            ### ë‹¤ìš´ë¡œë“œ
            - Latest: [coderay-open-api.jar](https://github.com/${{ github.repository }}/releases/download/latest/coderay-open-api.jar)
            - ì´ ë²„ì „: [coderay-open-api.jar](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/coderay-open-api.jar)
                        
            ### ë³€ê²½ì‚¬í•­
            ${{ inputs.title || 'Release ' }}${{ steps.version.outputs.version }}

      # 5. latest íƒœê·¸ ì‚­ì œ ë° ì¬ìƒì„±
      - name: Delete and recreate latest tag
        run: |
          # ë¡œì»¬ latest íƒœê·¸ ì‚­ì œ (ìˆì„ ê²½ìš°)
          git tag -d latest || true
          # ì›ê²© latest íƒœê·¸ ì‚­ì œ (ìˆì„ ê²½ìš°)
          git push origin :refs/tags/latest || true
          # ìƒˆë¡œìš´ latest íƒœê·¸ ìƒì„±
          git tag -f latest
          # latest íƒœê·¸ í‘¸ì‹œ
          git push origin latest --force
        shell: bash

      # 6. latest ë¦´ë¦¬ì¦ˆ ìƒì„±/ì—…ë°ì´íŠ¸
      - name: Create/Update Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Release
          draft: false
          prerelease: false
          files: ./artifacts/latest/coderay-open-api.jar
          body: |
            ## ğŸ“¦ Latest Release
            
            í˜„ì¬ ìµœì‹  ë²„ì „: **${{ steps.version.outputs.version }}**
            
            ### ë‹¤ìš´ë¡œë“œ
            - [coderay-open-api.jar](https://github.com/${{ github.repository }}/releases/download/latest/coderay-open-api.jar)
            
            ### ì•ˆë‚´
            í•­ìƒ ìµœì‹  ë²„ì „ì„ ì‚¬ìš©í•˜ë ¤ë©´ ìœ„ ë§í¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
            íŠ¹ì • ë²„ì „ì´ í•„ìš”í•˜ë©´ [Releases í˜ì´ì§€](https://github.com/${{ github.repository }}/releases)ì—ì„œ í•´ë‹¹ ë²„ì „ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
